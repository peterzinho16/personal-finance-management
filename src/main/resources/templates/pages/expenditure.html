<!DOCTYPE html>
<html lang="en-us"
      xmlns:th="http://www.thymeleaf.org">

<!-- Include the head fragment -->
<head th:replace="~{html-commons/head :: fg-head(title='Expenditures')}"></head>

<body>
<!-- Include the sidebar fragment -->
<div th:replace="~{html-commons/sidebar :: fg-sidebar}"></div>

<div class="content compressed">
    <div class="header d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-light" id="toggle-sidebar">â˜°</button>
        <h1>Expenditures</h1>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 pt-2">
                <div class="mb-3">
                    <label for="subCategorySelect" class="form-label">Sub categoria:</label>
                    <select class="form-select" id="subCategorySelect">
                        <option value="Por definir">Por definir</option>
                        <option value="0" selected>Todos</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table id="expenditure-table" class="table table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th title="Subject from mail">Description</th>
                    <th>Payee</th>
                    <th>Amount</th>
                    <th title="Transaction Date">T. Date</th>
                    <th>Category</th>
                    <th title="Sub Category">Sub Category</th>
                    <th title="Shared Amount">S. Amount</th>
                    <th title="Indicate if the expense is shared">Shared</th>
                    <th title="Indicate if the expense was made for another person">Lent</th>
                    <th title="Indicate for who was the loan">Lent To</th>
                    <th title="Indicate if this expense was borrowed by somebody">Borrowed</th>
                    <th>Options Menu</th>
                </tr>
                </thead>
                <tbody id="expenditure-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="errorToastTitle"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="errorToastBody"></div>
    </div>
</div>

<!-- Slide Form -->
<div class="slide-form" id="slideForm">
    <div class="p-4">
        <h5>Edit Expenditure</h5>
        <button type="button" class="btn-close" id="closeSlideForm" aria-label="Close"></button>
        <form id="edit-form">
            <input type="hidden" id="entity-id">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="edit-description" class="form-label">Description</label>
                    <input type="text" class="form-control" id="edit-description">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="edit-payee" class="form-label">Payee (Read only)</label>
                    <input readonly="readonly" type="text" class="form-control" id="edit-payee">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="edit-amount" class="form-label">Amount</label>
                    <input type="number" step="0.01" class="form-control" id="edit-amount">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="edit-transactionDate" class="form-label">Transaction Date</label>
                    <input type="datetime-local" class="form-control" id="edit-transactionDate">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="lentCheckbox" class="form-label">Lent</label>
                            <label class="switch">
                                <input type="checkbox" id="lentCheckbox" name="lent" value="false">
                                <span class="slider"></span>
                            </label>

                        </div>
                        <div class="col-md-6 mb-3" id="lentToContainer" style="display: none;">
                            <label for="lentToInput" class="form-label">Lent to <span class="badge bg-primary">(Default value: Amor)</span></label>
                            <input type="text" id="lentToInput" name="lentTo" class="form-control" maxlength="36">
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="installmentsCheckbox" class="form-label">Installments?</label>
                            <label class="switch">
                                <input type="checkbox" id="installmentsCheckbox" name="installments" value="false">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="col-md-6 mb-3" id="totalInstallmentsContainer" style="display: none;">
                            <label for="totalInstallmentsInput" class="form-label">Total</label>
                            <input type="number" id="totalInstallmentsInput" name="totalInstallments"
                                   class="form-control"
                                   maxlength="48" value="1">
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Sub Category</label>
                    <div id="category-container" class="row"></div>
                </div>
            </div>
            <button type="button" class="btn btn-primary fixed-save-button hidden" id="save-changes">Save changes
            </button>
        </form>
    </div>
</div>

<!-- Include the scripts fragment -->
<div th:replace="~{html-commons/scripts :: fg-js}"></div>
<script>
    $(document).ready(function () {
        const apiEndpoint = "http://localhost:8080/eureka/finance-app/expenditure";
        const apiEndpointMailMessage = "http://localhost:8080/eureka/finance-app/mail-message";
        const subCategoryEndpoint = "http://localhost:8080/eureka/finance-app/sub-category";

        // Show/hide lentTo input based on lent checkbox
        $("#lentCheckbox").on("change", function () {
            if ($(this).is(":checked")) {
                $("#lentToContainer").show();
                $("#lentToInput").val('Amor');
            } else {
                $("#lentToContainer").hide();
                $("#lentToInput").val('');
            }
        });

        // Show/hide installment input based on installments checkbox
        $("#installmentsCheckbox").on("change", function () {
            if ($(this).is(":checked")) {
                $("#totalInstallmentsContainer").show();
                $("#totalInstallmentsInput").val(1);
            } else {
                $("#totalInstallmentsContainer").hide();
                $("#totalInstallmentsInput").val('');
            }
        });

        // Fetch subcategories and populate the category container
        $.ajax({
            url: subCategoryEndpoint,
            method: 'GET',
            success: function (subCategories) {
                generateCatAndSubCat(subCategories);
            },
            error: function (error) {
                console.error("Error fetching subcategories:", error);
                showErrorToast(error.status, error.responseJSON.message);
            }
        });
        // Initialize DataTable
        const table = $("#expenditure-table").DataTable({
            processing: true,
            serverSide: true,
            ajax: function (data, callback) {
                const page = data.start / data.length;
                const size = data.length;
                const subCategoryName = $("#subCategorySelect").val();
                let url = `${apiEndpoint}?page=${page}&size=${size}`;
                if (subCategoryName !== "0") {
                    url += `&subCategoryName=${subCategoryName}`;
                }

                $.ajax({
                    url: url,
                    success: function (response) {
                        const rows = response.content.map(exp => [
                            exp.id,
                            `<span title="${exp.description}">${exp.description}</span>`,
                            exp.payee,
                            exp.currency === 'PEN' ? 'S/ ' + exp.amount.toFixed(2) : '$ ' + exp.amount.toFixed(2),
                            formatDateWithMonthText(exp.transactionDate),
                            exp.subCategory.category.name,
                            exp.subCategory.name,
                            exp.sharedAmount ? exp.currency === 'PEN' ? 'S/ ' + exp.sharedAmount.toFixed(2) : '$ ' + exp.sharedAmount.toFixed(2) : '-',
                            `<input type="checkbox" class="form-check-input" ${exp.shared ? 'checked' : ''} onchange="toggleShared(${exp.id}, this.checked)">`,
                            `<input disabled type="checkbox" class="form-check-input" ${exp.lent ? 'checked' : ''}>`,
                            exp.lentTo ? exp.lentTo : '-',
                            `<input disabled type="checkbox" class="form-check-input" ${exp.wasBorrowed ? 'checked' : ''}>`,
                            `<a href="#" class="btn btn-sm btn-primary" title="Edit" onclick="editExpenditure(${exp.id})">
                                <i class="bi bi-pencil"></i>
                            </a>
                                 <a href="#" class="btn btn-sm btn-danger" title="Delete" onclick="deleteExpenditure(${exp.id})">
                                <i class="bi bi-trash"></i>
                            </a>
                            <a href="#" class="btn btn-sm btn-info" title="Link" onclick="goToLink('${exp.referenceId.replace(/'/g, "\\'")}')">
                                <i class="bi bi-send"></i>
                            </a>`
                        ]);

                        callback({
                            draw: data.draw,
                            recordsTotal: response.totalElements,
                            recordsFiltered: response.totalElements,
                            data: rows,
                        });
                        setTimeout(() => enableToolTipForDescriptionOnTableElements(), 250);
                    },
                    error: function (error) {
                        console.error("Error fetching expenditures:", error);
                        showErrorToast(error.status, error.responseJSON.message);
                    }
                });
            },
            pageLength: 15,
            lengthMenu: [8, 15, 20, 50],
            responsive: true,
        });

        // Event listener for subCategorySelect
        $("#subCategorySelect").on("change", function () {
            table.ajax.reload();
        });

        // Edit Expenditure function
        window.editExpenditure = async function (id) {
            try {
                const response = await fetch(`${apiEndpoint}/${id}`);
                const exp = await response.json();

                $("#entity-id").val(exp.id);
                $("#edit-description").val(exp.description);
                $("#edit-payee").val(exp.payee);
                $("#edit-amount").val(exp.amount);
                $("#edit-transactionDate").val(exp.transactionDate);
                $(`#subCategory-${exp.subCategory.id}`).prop('checked', true);
                $("#lentCheckbox").prop('checked', exp.lent);
                var wasFinanced = exp.installments > 1;
                $("#installmentsCheckbox").prop('checked', wasFinanced);
                if(wasFinanced) {
                    $("#totalInstallmentsContainer").show();
                    $("#totalInstallmentsInput").val(exp.installments);
                } else {
                    $("#totalInstallmentsContainer").hide();
                    $("#totalInstallmentsInput").val(1);
                }
                if (exp.lent) {
                    $("#lentToContainer").show();
                    $("#lentToInput").val(exp.lentTo);
                } else {
                    $("#lentToContainer").hide();
                    $("#lentToInput").val('');
                }

                $("#slideForm").addClass("active");
                $("#save-changes").removeClass("hidden");
            } catch (error) {
                console.error("Error fetching expenditure details:", error);
                showErrorToast(error.status, error.responseJSON.message);
            }
        };

        // Link Expenditure function
        window.goToLink = async function (referenceId) {
            try {
                const response = await fetch(`${apiEndpointMailMessage}/by/reference-id/${referenceId}`);
                const mailMessage = await response.json();
                window.open(mailMessage.webLink, '_blank'); // '_blank' opens the link in a new tab
            } catch (error) {
                console.error("Error fetching expenditure details:", error);
                showErrorToast(error.status, error.responseJSON.message);
            }
        };

        // Save changes
        $("#save-changes").on("click", function () {
            const entityId = $("#entity-id").val();
            const subCategoryId = $("input[name='subCategory']:checked").val();
            const lent = $("#lentCheckbox").is(":checked");
            const lentTo = lent ? $("#lentToInput").val() : null;
            const financed = $("#installmentsCheckbox").is(":checked");
            const installments = financed ? $("#totalInstallmentsInput").val() : 1;

            const data = {
                description: $("#edit-description").val(),
                payee: $("#edit-payee").val(),
                amount: $("#edit-amount").val(),
                transactionDate: $("#edit-transactionDate").val(),
                subCategoryId: subCategoryId,
                lent: lent,
                lentTo: lentTo,
                installments: installments
            };

            $.ajax({
                url: `${apiEndpoint}/${entityId}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    console.log("Update successful:", response);
                    $("#slideForm").removeClass("active");
                    $("#save-changes").addClass("hidden");
                    table.ajax.reload(function () {
                        // Highlight the updated row
                        const row = $(`#expenditure-table tbody tr`).filter(function () {
                            return $(this).find('td').first().text() == entityId;
                        });
                        row.addClass("highlight");
                        setTimeout(function () {
                            row.removeClass("highlight");
                        }, 3000);
                    });
                },
                error: function (error) {
                    console.error("Error updating expenditure:", error);
                    showErrorToast(error.status, error.responseJSON.message);
                }
            });
        });

        // Toggle shared status
        window.toggleShared = function (id, shared) {
            $.ajax({
                url: `${apiEndpoint}/${id}/update/shared`,
                method: 'PUT',
                contentType: 'application/json',
                success: function (response) {
                    console.log("Shared status updated:", response);
                    table.ajax.reload();
                },
                error: function (error) {
                    console.error("Error updating shared status:", error);
                    showErrorToast(error.status, error.responseJSON.message);
                }
            });
        };

    });

</script>
</body>

</html>
