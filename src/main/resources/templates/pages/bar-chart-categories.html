<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Expenditure Bar Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
    <style>
        body {
            padding: 1rem;
        }

        #chart-wrapper {
            position: relative;
            width: 100%;
            height: 60vh;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <h1 class="mb-4">Expenditure Bar Graph</h1>

    <div class="mb-3">
        <label for="month-filter" class="form-label">Select Month:</label>
        <select id="month-filter" class="form-select w-auto"></select>
    </div>

    <div id="chart-wrapper">
        <canvas id="expenditure-chart"></canvas>
    </div>
</div>

<script>
    fetch('/eureka/finance-app/expenditure/reports/get-category-monthly-totals')
        .then(response => response.json())
        .then(data => {
            let chartInstance = null;

            const months = Array.from(new Set(data.map(item => item.periodo)))
                .filter(periodo => {
                    const [year] = periodo.split('-');
                    return parseInt(year) >= 2025;
                })
                .sort()
                .reverse();

            const monthFilter = document.getElementById('month-filter');
            months.forEach(periodo => {
                const [year, monthNum] = periodo.split('-');
                const date = new Date(parseInt(year), parseInt(monthNum) - 1, 1);

                const option = document.createElement('option');
                option.value = periodo;
                option.textContent = date.toLocaleString('default', {month: 'long', year: 'numeric'});
                monthFilter.appendChild(option);
            });

            const groupByCategory = (filteredData) => {
                const totals = {};
                filteredData.forEach(item => {
                    if (!totals[item.categoria]) {
                        totals[item.categoria] = {individual: 0, shared: 0};
                    }
                    totals[item.categoria].individual += item.gastosIndividuales || 0;
                    totals[item.categoria].shared += item.gastosCompartidos || 0;
                });
                return totals;
            };

            const renderChart = (totals) => {
                const ctx = document.getElementById('expenditure-chart').getContext('2d');
                if (chartInstance) chartInstance.destroy();

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(totals),
                        datasets: [
                            {
                                label: 'Individual Expenses (PEN)',
                                data: Object.values(totals).map(t => t.individual),
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Shared Expenses (PEN)',
                                data: Object.values(totals).map(t => t.shared),
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { enabled: true },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toFixed(2), // Format to 2 decimal places
                                font: {
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    },
                    plugins: [ChartDataLabels] // Register the plugin
                });

            };

            const currentMonth = monthFilter.value || months[0];
            monthFilter.value = currentMonth;
            const initialFiltered = data.filter(item => item.periodo === currentMonth);
            renderChart(groupByCategory(initialFiltered));

            monthFilter.addEventListener('change', (event) => {
                const selected = event.target.value;
                const filtered = data.filter(item => item.periodo === selected);
                const totals = groupByCategory(filtered);
                renderChart(totals);
            });
        });
</script>

</body>
</html>
