<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{html-commons/head :: fg-head(title='Expenditures â€“ Resumen', includeAppCss=false)}"></head>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.1.0/mdb.min.css" rel="stylesheet">

<style>
    :root{
        --bg:#f5f7fb;
        --card:#ffffff;
        --text:#0f172a;
        --muted:#6b7280;
        --brand:#2563eb;
        --ring:rgba(37,99,235,.15);
        --radius:18px;
        --sidebar-w:280px;
    }
    html,body{height:100%}
    body{
        background:var(--bg);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", sans-serif;
        color:var(--text);
    }

    /* Layout */
    .app{display:grid; grid-template-columns: var(--sidebar-w) 1fr; min-height:100%}

    /* Sidebar â€“ light, rounded, like the screenshot */
    .sidebar{
        background:#fff; padding:20px 14px; position:sticky; top:0; height:100vh;
        border-right:1px solid #eef0f5; border-top-right-radius:16px; border-bottom-right-radius:16px;
    }
    .sb-title{
        font-weight:800; font-size:26px; margin:6px 8px 18px; letter-spacing:.2px;
    }
    .sb-list{list-style:none; padding:0; margin:0}
    .sb-item>a{
        display:flex; align-items:center; gap:12px; padding:12px 12px; margin:6px 6px;
        color:#1f2937; text-decoration:none; border-radius:12px; font-weight:600;
        transition:background .15s ease, color .15s ease;
    }
    .sb-item>a:hover{ background:#f3f6ff; color:#1e40af }
    .sb-item a .bi{ font-size:20px; color:#6b7280 }
    .sb-item.active>a{ background:#eef2ff; color:#1e40af }
    .sb-item.active>a .bi{ color:#1e40af }

    /* Submenu for Expenses */
    .submenu{ margin-left:42px; margin-top:2px; margin-bottom:6px; display:none }
    .submenu a{
        display:block; padding:8px 10px; margin:4px 6px; border-radius:10px; color:#374151; text-decoration:none; font-weight:500;
    }
    .submenu a:hover{ background:#f6f7fb }
    .sb-caret{ margin-left:auto; transition:transform .15s ease }
    .sb-item.open .sb-caret{ transform:rotate(90deg) }
    .sb-item.open .submenu{ display:block }

    /* Topbar minimal */
    .topbar{
        height:64px; display:flex; align-items:center; justify-content:space-between;
        padding:0 20px; background:#373b3b; position:sticky; top:0; z-index:5;
    }

    /* Body header row (where period + user live now) */
    .content{ padding:16px 24px 28px }
    .page-header{
        display:flex; justify-content:space-between; align-items:center; margin-bottom:18px
    }
    .page-header .title{ font-weight:800; font-size:32px }
    .header-actions{ display:flex; align-items:end; gap:12px }
    .field{
        display:flex; flex-direction:column; gap:6px;
    }
    .field label{ font-size:12px; color:var(--muted); font-weight:700 }
    .select-clean{
        border:1px solid #e5e7eb; border-radius:12px; padding:10px 14px; background:#fff; font-weight:600;
        min-width:160px;
    }

    .avatar-btn{
        width:38px; height:38px; border-radius:999px; display:grid; place-items:center;
        background:#eef2ff; color:#4f46e5; border:none;
    }

    /* Cards / metrics */
    .card-ui{ background:var(--card); border:0; border-radius:var(--radius); box-shadow:0 10px 24px rgba(16,24,40,.06) }
    .grid{ display:grid; gap:18px; grid-template-columns: repeat(12, minmax(0,1fr)) }
    .grid {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .col-3{ grid-column: span 3 } .col-4{ grid-column: span 4 } .col-6{ grid-column: span 6 } .col-12{ grid-column: span 12 }

    .metric{ padding:22px; border-radius:16px; border:1px solid #eef0f5 }
    .metric .label{ color:var(--muted); font-weight:600; font-size:14px; margin-bottom:8px }
    .metric .value{ font-size:28px; font-weight:800; letter-spacing:.2px }

    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
        font-weight:700; font-size:13px; border:1px solid #e5e7eb; background:#fff }
    .pill.warning{ color:#a16207; background:#fffbeb; border-color:#fde68a }
    .pill.info{ color:#075985; background:#ecfeff; border-color:#a5f3fc }

    .loan-card{ border:1px solid #eef0f5; border-radius:16px; padding:16px; background:#fff; height:100% }
    .amount{ font-weight:800; font-size:22px }
    .shadow-hover{ transition: transform .15s ease, box-shadow .15s ease }
    .shadow-hover:hover{ transform: translateY(-2px); box-shadow: 0 12px 28px rgba(20,35,90,.08) }

    /* Topbar search input (âŒ˜K) */
    .topbar .searchbar{position:relative; width:clamp(220px,28vw,340px)}
    .topbar .search-input{
        height:36px; width:100%;
        border:1px solid #e5e7eb; border-radius:12px;
        padding:0 44px 0 36px; background:#fff; font-weight:500;
        box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .topbar .search-input:focus{
        outline:0; border-color:var(--brand); box-shadow:0 0 0 3px var(--ring);
    }
    .topbar .search-icon{
        position:absolute; left:12px; top:50%; transform:translateY(-50%);
        color:#6b7280; font-size:18px;
    }
    .topbar .kbd-badge{
        position:absolute; right:8px; top:50%; transform:translateY(-50%);
        padding:2px 6px; border:1px solid #e5e7eb; border-radius:6px;
        font-size:12px; color:#64748b; background:#fff;
    }

    /* Avatar button & dropdown */
    .avatar-btn{ width:38px; height:38px; border-radius:999px; border:0; display:grid; place-items:center;
        background:#eef2ff; color:#4f46e5; }
    .avatar-btn.dropdown-toggle::after{ display:none; }

    /* Toggle button */
    .sb-toggle{
        position: absolute;
        top: 50%;
        right: -14px;                 /* pulls it slightly outside so it doesn't touch the title */
        transform: translateY(-50%);
        width: 36px;
        height: 36px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #f8fafc;
        color: #4f46e5;
        display: grid;
        place-items: center;
        box-shadow: 0 4px 12px rgba(16,24,40,.12);
        z-index: 20;
    }
    .sb-toggle:hover{ background:#eef2ff }
    .sb-toggle .bi{ transition: transform .2s ease }
    .sidebar { overflow: visible; }

    /* Collapsed state */
    .app.is-collapsed{ --sidebar-w:84px }            /* shrinks the grid column */
    .app.is-collapsed .sidebar .sb-title{ display:none }
    .app.is-collapsed .sidebar a span{ display:none } /* hide labels */
    .app.is-collapsed .sb-caret{ display:none }       /* hide submenu caret */
    .app.is-collapsed .submenu{ display:none }        /* hide open submenus */
    .app.is-collapsed .sb-toggle .bi{ transform:rotate(180deg) } /* flip chevron */



    @media (max-width: 1100px){
        :root{ --sidebar-w:90px }
        .sb-title{ display:none }
        .sb-item>a span{ display:none }
        .submenu{ margin-left:16px }
    }
    @media (max-width: 920px){
        .grid{ grid-template-columns: repeat(6, minmax(0,1fr)) }
        .col-3{ grid-column: span 3 } .col-4{ grid-column: span 6 }
    }
    @media (max-width: 640px){
        .app {
            display: block; /* ðŸ‘ˆ stop using grid for layout */
            position: relative;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 240px;
            height: 100%;
            z-index: 1000;
            background: #fff;
            border-right: 1px solid #eef0f5;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            border-radius: 0;
        }
        .app.sidebar-open .sidebar {
            transform: translateX(0);
        }
        main {
            margin-left: 0; /* ðŸ‘ˆ ensures main content takes full width */
            width: 100%;
        }
        .topbar {
            position: sticky;
            top: 0;
            z-index: 900;
        }
        .grid{ grid-template-columns: 1fr; }
        .grid > * {
            width: 100%;
        }
        .col-3,.col-4,.col-6{ grid-column: span 4 }
        .page-header{ align-items:start; gap:12px; flex-direction:column }
        .header-actions{ width:100%; justify-content:space-between }

        /* Mobile adjustments for metrics and loan cards */
        .metric {
            padding: 12px;
        }
        .metric .value {
            font-size: 18px;
        }
        .metric .label {
            font-size: 13px;
        }
        .loan-card {
            padding: 10px;
        }
        .loan-card .amount {
            font-size: 18px;
        }
        .loan-card .small {
            font-size: 12px;
        }
    }

    /* --- Responsive grid transitions for tablet and phone --- */
    @media (max-width: 768px) and (min-width: 641px) {
        .grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .metric .value {
            font-size: 20px;
        }
        .metric {
            padding: 14px;
        }
    }

    @media (max-width: 480px) {
        .grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        .metric .value {
            font-size: 16px;
        }
        .metric {
            padding: 10px;
        }
        .loan-card {
            padding: 8px;
        }
        .loan-card .amount {
            font-size: 16px;
        }
    }

    .span-force-display {
        display: block !important;
    }
</style>

<body>
<div class="app">

    <!-- Sidebar -->
    <aside class="sidebar">
        <button class="sb-toggle" id="sbToggle" type="button"
                aria-label="Toggle sidebar" aria-expanded="true"
                onclick="toggleSidebar()">
            <i class="bi bi-chevron-left"></i>
        </button>

        <div class="sb-title">Admin Dashboard</div>
        <ul class="sb-list">
            <li class="sb-item"><a href="/home"><i class="bi bi-grid-3x3-gap"></i><span>Dashboard</span></a></li>

            <li class="sb-item" id="expItem">
                <a href="javascript:void(0)" onclick="toggleSubmenu('expItem')">
                    <i class="bi bi-wallet2"></i><span>Expenses</span>
                    <i class="bi bi-chevron-right sb-caret"></i>
                </a>
                <div class="submenu">
                    <a href="/expenditure/new">New expense</a>
                    <a href="/expenditure/list">List</a>
                    <a href="/expenditure/reports">Reports</a>
                </div>
            </li>

            <li class="sb-item"><a href="/income"><i class="bi bi-coin"></i><span>Income</span></a></li>
            <li class="sb-item"><a href="/categories"><i class="bi bi-folder2"></i><span>Categories</span></a></li>
            <li class="sb-item"><a href="/home/others"><i class="bi bi-card-text"></i><span>Expenditure Others</span></a></li>
            <li class="sb-item"><a href="/resume"><i class="bi bi-journal-text"></i><span>Resume</span></a></li>
        </ul>
    </aside>

    <!-- Main -->
    <main>

        <!-- Topbar -->
        <div class="topbar">
            <div class="d-flex align-items-center gap-3 ms-auto">
                <!-- Search -->
                <div class="searchbar d-none d-md-block">
                    <i class="bi bi-search search-icon"></i>
                    <input class="search-input" type="text" placeholder="Search expenditures" />
                    <span class="kbd-badge">âŒ˜ K</span>
                </div>

                <!-- Optional icons -->
                <button type="button" class="btn btn-link text-muted p-2" title="Notifications">
                    <i class="bi bi-bell"></i>
                </button>
                <button type="button" class="btn btn-link text-muted p-2" title="Apps">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>

                <!-- User dropdown (Bootstrap, no MDB attribute) -->
                <div class="dropdown">
                    <button class="avatar-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="User menu">
                        <i class="bi bi-person"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm p-2">
                        <li><a class="dropdown-item" href="/profile"><i class="bi bi-person-circle me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
                        <li><a class="dropdown-item" href="/billing"><i class="bi bi-credit-card me-2"></i>Billing</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>

        </div>


        <div class="content">

            <!-- Body header (no user icon here) -->
            <div class="page-header">
                <div class="title">Resumen General</div>
                <div class="header-actions">
                    <div class="field">
                        <label for="periodSelect">Periodo</label>
                        <select id="periodSelect" class="select-clean"></select>
                    </div>
                </div>
            </div>


            <!-- Summary metrics (responsive, no .col-* wrappers) -->
            <div class="grid mb-4">
                <div class="card-ui p-3" style="grid-column: 1 / -1;">
                    <div class="grid">
                        <div class="metric shadow-hover">
                            <div class="label">Otros ingresos</div>
                            <div id="otrosIngresos" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover">
                            <div class="label">Total gastos</div>
                            <div id="totalGastos" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover">
                            <div class="label">Gastos compartidos</div>
                            <div id="gastosCompartidos" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover">
                            <div class="label">Mis gastos compartidos (importados)</div>
                            <div id="misGastosCompartidos" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover text-bg-primary">
                            <div class="label text-white">Gastos a devolver</div>
                            <div id="gastosADevolver" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover">
                            <div class="label d-flex align-items-center gap-1">
                                Gasto neto
                                <i class="bi bi-info-circle text-muted"
                                   data-bs-toggle="tooltip"
                                   data-bs-placement="top"
                                   title="Gasto neto = Total gastos - Otros ingresos"></i>
                            </div>
                            <div id="gastoNeto" class="value">S/ 0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dinero prestado -->
            <div class="card-ui p-4 mb-4" style="grid-column: 1 / -1;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="pill warning"><i class="bi bi-arrow-up-right-circle"></i> Dinero prestado (pendiente de pago)</span>
                </div>
                <div id="lentSection" class="grid"></div>
            </div>

            <!-- Dinero recibido -->
            <div class="card-ui p-4" style="grid-column: 1 / -1;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="pill info"><i class="bi bi-arrow-down-circle"></i> Dinero recibido (por devolver)</span>
                </div>
                <div id="borrowedSection" class="grid"></div>
            </div>

        </div>
    </main>
</div>

<!-- JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.1.0/mdb.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el, {
            delay: { show: 0, hide: 0 } // ðŸ‘ˆ removes the delay
        }));
    });

    // Sidebar submenu toggle
    function toggleSubmenu(id){
        document.getElementById(id).classList.toggle('open');
    }

    // Mock for lists (keep your backend summary call as-is)
    const mockData = {
        summary:{ periodo:"2025-10", otrosIngresos:999.99, totalGastos:999.99, gastosCompartidos:999.99, misGastosCompartidosImportados:999.99, gastosADevolver:999.99 },
        lent:[
            {"periodo": "2025-05", "loanState": "PAID", "lentTo": "Amor", "montoAcumulado": 72.3},
            {"periodo": "2025-05", "loanState": "PAID", "lentTo": "Fader", "montoAcumulado": 73.02},
            {"periodo": "2025-05", "loanState": "PAID", "lentTo": "Amor", "montoAcumulado": 100.8},
            {"periodo": "2025-05", "loanState": "PENDING", "lentTo": "Rodrigo", "montoAcumulado": 100.8}
        ],
        borrowed:[
            {id:203, periodo:"2025-07", borrowedFrom:"Amor", montoAcumulado:1287.50, borrowedState:"PENDING"},
            {id:204, periodo:"2025-08", borrowedFrom:"Fader", montoAcumulado:643.26, borrowedState:"PAID"},
            {id:203, periodo:"2025-07", borrowedFrom:"Hermano", montoAcumulado:1287.50, borrowedState:"PENDING"},
            {id:204, periodo:"2025-08", borrowedFrom:"Amor", montoAcumulado:643.26, borrowedState:"PAID"}
        ]
    };
    const realFetch = window.fetch;

    window.fetch = async (url, options = {}) => {
        // const method = (options.method || 'GET').toUpperCase(); // default to GET if not specified

        // // Example: mock /api/resume/lent GET
        // if (url.includes('/api/resume/lent') && method === 'GET') {
        //     console.log('Mocking GET /api/resume/lent');
        //     return { json: async () => mockData.lent };
        // }

        // // Example: mock /api/resume/borrowed GET
        // if (url.includes('/api/resume/borrowed') && method === 'GET') {
        //     console.log('Mocking GET /api/resume/borrowed');
        //     return { json: async () => mockData.borrowed };
        // }

        // // Example: mock PUT for pay endpoints
        // if (url.includes('/pay') && method === 'PUT') {
        //     console.log('Mocking PUT /pay');
        //     return { ok: true };
        // }

        // fallback to real fetch
        return realFetch(url, options);
    };

    const PEN = new Intl.NumberFormat('es-PE', { style:'currency', currency:'PEN', minimumFractionDigits:2 });

    document.addEventListener('DOMContentLoaded', async ()=>{
        const periodSelect = document.getElementById('periodSelect');
        const periods = [];
        const today = new Date();
        for(let i=5;i>=0;i--){
            const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            periods.push(`${y}-${m}`);
        }
        periods.reverse();
        periods.forEach(p=>{
            const opt=document.createElement('option'); opt.value=p; opt.textContent=p; periodSelect.appendChild(opt);
        });
        periodSelect.value = periods[0];
        await loadPeriodData(periodSelect.value);
        periodSelect.addEventListener('change', async e => { await loadPeriodData(e.target.value); });
    });

    async function loadPeriodData(period){
        await Promise.all([ loadSummary(period), loadLent(period), loadBorrowed(period) ]);
    }

    // Helper to get startDate and endDate from period string
    function getPeriodRange(period) {
        const [year, month] = period.split('-').map(Number);
        const startDate = `${String(year).padStart(4, '0')}-${String(month).padStart(2, '0')}-01`;
        let ny = year, nm = month + 1;
        if (nm > 12) { nm = 1; ny += 1; }
        const endDate = `${String(ny).padStart(4, '0')}-${String(nm).padStart(2, '0')}-01`;
        return { startDate, endDate };
    }

    async function loadSummary(period) {
        const { startDate, endDate } = getPeriodRange(period);
        const data = await fetch(`/api/resume/summary?startDate=${startDate}&endDate=${endDate}`).then(r=>r.json());
        const row = data?.[0] ?? mockData.summary;

        document.getElementById('otrosIngresos').textContent        = PEN.format(row.otrosIngresos ?? 0);
        document.getElementById('totalGastos').textContent          = PEN.format(row.finalTotalGastos ?? row.totalGastos ?? 0);
        document.getElementById('gastosCompartidos').textContent    = PEN.format(row.gastosCompartidos ?? 0);
        document.getElementById('misGastosCompartidos').textContent = PEN.format(row.misGastosCompartidosImportados ?? 0);
        document.getElementById('gastosADevolver').textContent      = PEN.format(row.gastosADevolver ?? 0);
        document.getElementById('gastoNeto').textContent            = PEN.format(row.finalTotalGastos - (row.otrosIngresos ?? 0));
    }

    async function loadLent(period) {
        const { startDate, endDate } = getPeriodRange(period);
        const list = await fetch(`/api/resume/lent?startDate=${startDate}&endDate=${endDate}`).then(r => r.json());
        const c = document.getElementById('lentSection');
        if (!list.length) {
            c.innerHTML = `<div class="text-muted">No hay prÃ©stamos pendientes</div>`;
            return;
        }

        // Group by lentTo and calculate totals for PENDING / PAID
        const grouped = {};
        for (const item of list) {
            const name = item.lentTo;
            if (!grouped[name]) {
                grouped[name] = { lentTo: name, pending: 0, paid: 0 };
            }
            if (item.loanState === 'PENDING') grouped[name].pending += item.montoAcumulado ?? 0;
            else if (item.loanState === 'PAID') grouped[name].paid += item.montoAcumulado ?? 0;
        }

        const cards = Object.values(grouped).map(l => {
            const hasPending = l.pending > 0;
            const paidIcon = !hasPending
                ? `<i class="bi bi-check-circle-fill text-success" title="Deuda pagada"></i>`
                : '';

            return `
                  <div class="loan-card shadow-hover h-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-arrow-up-right-circle text-warning"></i>
                        <span class="fw-semibold">${l.lentTo}</span>
                      </div>
                      ${paidIcon}
                    </div>
                    <div class="small text-muted">Monto pendiente</div>
                    <div class="amount my-1">${PEN.format(l.pending)}</div>

                    <div class="small text-muted mt-2">Monto pagado</div>
                    <div class="amount text-success my-1">${PEN.format(l.paid)}</div>

                    <button class="btn btn-primary btn-sm w-100 mt-3"
                            ${hasPending ? '' : 'disabled'}
                            onclick="${hasPending ? `markLentAsPaid('${l.lentTo}')` : ''}">
                      ${hasPending ? 'Liquidar' : 'Pagado'}
                    </button>
                  </div>`;
        });
        c.innerHTML = cards.join('');
    }

    async function loadBorrowed(period) {
        const { startDate, endDate } = getPeriodRange(period);
        const list = await fetch(`/api/resume/borrowed?startDate=${startDate}&endDate=${endDate}`).then(r => r.json());
        const c = document.getElementById('borrowedSection');
        if (!list.length) {
            c.innerHTML = `<div class="text-muted">No hay deudas pendientes</div>`;
            return;
        }

        // Group by borrowedFrom and calculate totals for PENDING / PAID
        const grouped = {};
        for (const item of list) {
            const name = item.borrowedFrom;
            if (!grouped[name]) {
                grouped[name] = { borrowedFrom: name, pending: 0, paid: 0 };
            }
            if (item.borrowedState === 'PENDING') grouped[name].pending += item.montoAcumulado ?? 0;
            else if (item.borrowedState === 'PAID') grouped[name].paid += item.montoAcumulado ?? 0;
        }

        console.log(grouped);

        const cards = Object.values(grouped).map(b => {
            const hasPending = b.pending > 0;
            const paidIcon = !hasPending
                ? `<i class="bi bi-check-circle-fill text-success" title="Deuda liquidada"></i>`
                : '';

            return `
                  <div class="loan-card shadow-hover h-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-arrow-down-circle text-info"></i>
                        <span class="fw-semibold">${b.borrowedFrom}</span>
                      </div>
                      ${paidIcon}
                    </div>

                    <div class="small text-muted">Monto pendiente</div>
                    <div class="amount my-1">${PEN.format(b.pending)}</div>

                    <div class="small text-muted mt-2">Monto pagado</div>
                    <div class="amount text-success my-1">${PEN.format(b.paid)}</div>

                    <button class="btn btn-primary btn-sm w-100 mt-3"
                            ${hasPending ? '' : 'disabled'}
                            onclick="${hasPending ? `markBorrowedAsPaid('${b.borrowedFrom}')` : ''}">
                      ${hasPending ? 'Liquidar' : 'Pagado'}
                    </button>
                  </div>`;
        });

        c.innerHTML = cards.join('');
    }

    async function markLentAsPaid(lentTo) {
        // Compute startDate and endDate using helper
        const period = document.getElementById('periodSelect').value;
        const { startDate, endDate } = getPeriodRange(period);
        console.log(startDate, endDate, lentTo);
        await fetch(`/api/resume/lent/${lentTo}/pay?startDate=${startDate}&endDate=${endDate}`, { method:'PUT' });
        await loadLent(period);
    }
    async function markBorrowedAsPaid(borrowedFrom) {
        // Compute startDate and endDate using helper
        const period = document.getElementById('periodSelect').value;
        const { startDate, endDate } = getPeriodRange(period);
        console.log(startDate, endDate, borrowedFrom);
        await fetch(`/api/resume/borrowed/${borrowedFrom}/pay?startDate=${startDate}&endDate=${endDate}`, { method:'PUT' });
        await loadBorrowed(period);
    }

function toggleSidebar() {
    const app = document.querySelector('.app');
    const btn = document.getElementById('sbToggle');
    const isMobile = window.matchMedia('(max-width: 640px)').matches;

    const spans = document.querySelectorAll('.sidebar .sb-item>a span');

    if (isMobile) {
        const isOpen = app.classList.toggle('sidebar-open');
        btn.setAttribute('aria-expanded', isOpen);
        spans.forEach(ele => {
            console.log(ele);
            ele.classList.add('span-force-display');
        });
    } else {
        const isCollapsed = app.classList.toggle('is-collapsed');
        btn.setAttribute('aria-expanded', !isCollapsed);
        spans.forEach(ele => ele.classList.remove('span-force-display'));
    }
}

</script>
</body>
</html>
