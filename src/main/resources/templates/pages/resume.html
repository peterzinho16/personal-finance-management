<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{html-commons/head :: fg-head(title='Expenditures – Resumen', includeAppCss=true)}"></head>

<body>
<div class="app">

    <!-- Sidebar -->
    <aside th:replace="~{html-commons/sidebar :: fg-sidebar}"></aside>

    <!-- Main -->
    <main>

        <!-- Topbar -->
        <div th:replace="~{html-commons/topbar :: fg-topbar}"></div>

        <div class="content">

            <!-- Body header (no user icon here) -->
            <div class="page-header">
                <div class="title">Resumen General</div>
                <div class="header-actions">
                    <div class="field">
                        <label for="periodSelect">Periodo</label>
                        <select id="periodSelect" class="select-clean"></select>
                    </div>
                </div>
            </div>


            <!-- Summary metrics (responsive, no .col-* wrappers) -->
            <div class="grid mb-4">
                <div class="card-ui p-3" style="grid-column: 1 / -1;">
                    <div class="grid">
                        <div class="metric shadow-hover">
                            <div class="label">Otros ingresos</div>
                            <div id="otrosIngresos" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover">
                            <div class="label">Total gastos</div>
                            <div id="totalGastos" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover">
                            <div class="label">Gastos compartidos</div>
                            <div id="gastosCompartidos" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover">
                            <div class="label">Mis gastos compartidos (importados)</div>
                            <div id="misGastosCompartidos" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover text-bg-primary">
                            <div class="label text-white">Gastos a devolver</div>
                            <div id="gastosADevolver" class="value">S/ 0.00</div>
                        </div>

                        <div class="metric shadow-hover">
                            <div class="label d-flex align-items-center gap-1">
                                Gasto neto
                                <i class="bi bi-info-circle text-muted"
                                   data-bs-toggle="tooltip"
                                   data-bs-placement="top"
                                   title="Gasto neto = Total gastos - Otros ingresos"></i>
                            </div>
                            <div id="gastoNeto" class="value">S/ 0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dinero prestado -->
            <div class="card-ui p-4 mb-4" style="grid-column: 1 / -1;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="pill warning"><i class="bi bi-arrow-up-right-circle"></i> Dinero prestado (pendiente de pago)</span>
                </div>
                <div id="lentSection" class="grid"></div>
            </div>

            <!-- Dinero recibido -->
            <div class="card-ui p-4" style="grid-column: 1 / -1;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="pill info"><i class="bi bi-arrow-down-circle"></i> Dinero recibido (por devolver)</span>
                </div>
                <div id="borrowedSection" class="grid"></div>
            </div>

        </div>
    </main>
</div>

<!-- Include the scripts fragment -->
<div th:replace="~{html-commons/scripts :: fg-js}"></div>
<script>

    // Mock for lists (keep your backend summary call as-is)
    const mockData = {
        summary:{ periodo:"2025-10", otrosIngresos:999.99, totalGastos:999.99, gastosCompartidos:999.99, misGastosCompartidosImportados:999.99, gastosADevolver:999.99 },
        lent:[
            {"periodo": "2025-05", "loanState": "PAID", "lentTo": "Amor", "montoAcumulado": 72.3},
            {"periodo": "2025-05", "loanState": "PAID", "lentTo": "Fader", "montoAcumulado": 73.02},
            {"periodo": "2025-05", "loanState": "PAID", "lentTo": "Amor", "montoAcumulado": 100.8},
            {"periodo": "2025-05", "loanState": "PENDING", "lentTo": "Rodrigo", "montoAcumulado": 100.8}
        ],
        borrowed:[
            {id:203, periodo:"2025-07", borrowedFrom:"Amor", montoAcumulado:1287.50, borrowedState:"PENDING"},
            {id:204, periodo:"2025-08", borrowedFrom:"Fader", montoAcumulado:643.26, borrowedState:"PAID"},
            {id:203, periodo:"2025-07", borrowedFrom:"Hermano", montoAcumulado:1287.50, borrowedState:"PENDING"},
            {id:204, periodo:"2025-08", borrowedFrom:"Amor", montoAcumulado:643.26, borrowedState:"PAID"}
        ]
    };
    const realFetch = window.fetch;

    window.fetch = async (url, options = {}) => {
        // const method = (options.method || 'GET').toUpperCase(); // default to GET if not specified

        // // Example: mock /api/resume/lent GET
        // if (url.includes('/api/resume/lent') && method === 'GET') {
        //     console.log('Mocking GET /api/resume/lent');
        //     return { json: async () => mockData.lent };
        // }

        // // Example: mock /api/resume/borrowed GET
        // if (url.includes('/api/resume/borrowed') && method === 'GET') {
        //     console.log('Mocking GET /api/resume/borrowed');
        //     return { json: async () => mockData.borrowed };
        // }

        // // Example: mock PUT for pay endpoints
        // if (url.includes('/pay') && method === 'PUT') {
        //     console.log('Mocking PUT /pay');
        //     return { ok: true };
        // }

        // fallback to real fetch
        return realFetch(url, options);
    };

    const PEN = new Intl.NumberFormat('es-PE', { style:'currency', currency:'PEN', minimumFractionDigits:2 });

    document.addEventListener('DOMContentLoaded', async ()=>{
        const periodSelect = document.getElementById('periodSelect');
        const periods = [];
        const today = new Date();
        for(let i=5;i>=0;i--){
            const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            periods.push(`${y}-${m}`);
        }
        periods.reverse();
        periods.forEach(p=>{
            const opt=document.createElement('option'); opt.value=p; opt.textContent=p; periodSelect.appendChild(opt);
        });
        periodSelect.value = periods[0];
        await loadPeriodData(periodSelect.value);
        periodSelect.addEventListener('change', async e => { await loadPeriodData(e.target.value); });
    });

    async function loadPeriodData(period){
        await Promise.all([ loadSummary(period), loadLent(period), loadBorrowed(period) ]);
    }

    // Helper to get startDate and endDate from period string
    function getPeriodRange(period) {
        const [year, month] = period.split('-').map(Number);
        const startDate = `${String(year).padStart(4, '0')}-${String(month).padStart(2, '0')}-01`;
        let ny = year, nm = month + 1;
        if (nm > 12) { nm = 1; ny += 1; }
        const endDate = `${String(ny).padStart(4, '0')}-${String(nm).padStart(2, '0')}-01`;
        return { startDate, endDate };
    }

    async function loadSummary(period) {
        const { startDate, endDate } = getPeriodRange(period);
        const data = await fetch(`/api/resume/summary?startDate=${startDate}&endDate=${endDate}`).then(r=>r.json());
        const row = data?.[0] ?? mockData.summary;

        document.getElementById('otrosIngresos').textContent        = PEN.format(row.otrosIngresos ?? 0);
        document.getElementById('totalGastos').textContent          = PEN.format(row.finalTotalGastos ?? row.totalGastos ?? 0);
        document.getElementById('gastosCompartidos').textContent    = PEN.format(row.gastosCompartidos ?? 0);
        document.getElementById('misGastosCompartidos').textContent = PEN.format(row.misGastosCompartidosImportados ?? 0);
        document.getElementById('gastosADevolver').textContent      = PEN.format(row.gastosADevolver ?? 0);
        document.getElementById('gastoNeto').textContent            = PEN.format(row.finalTotalGastos - (row.otrosIngresos ?? 0));
    }

    async function loadLent(period) {
        const { startDate, endDate } = getPeriodRange(period);
        const list = await fetch(`/api/resume/lent?startDate=${startDate}&endDate=${endDate}`).then(r => r.json());
        const c = document.getElementById('lentSection');
        if (!list.length) {
            c.innerHTML = `<div class="text-muted">No hay préstamos pendientes</div>`;
            return;
        }

        // Group by lentTo and calculate totals for PENDING / PAID
        const grouped = {};
        for (const item of list) {
            const name = item.lentTo;
            if (!grouped[name]) {
                grouped[name] = { lentTo: name, pending: 0, paid: 0 };
            }
            if (item.loanState === 'PENDING') grouped[name].pending += item.montoAcumulado ?? 0;
            else if (item.loanState === 'PAID') grouped[name].paid += item.montoAcumulado ?? 0;
        }

        const cards = Object.values(grouped).map(l => {
            const hasPending = l.pending > 0;
            const paidIcon = !hasPending
                ? `<i class="bi bi-check-circle-fill text-success" title="Deuda pagada"></i>`
                : '';

            return `
                  <div class="loan-card shadow-hover h-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-arrow-up-right-circle text-warning"></i>
                        <span class="fw-semibold">${l.lentTo}</span>
                      </div>
                      ${paidIcon}
                    </div>
                    <div class="small text-muted">Monto pendiente</div>
                    <div class="amount my-1">${PEN.format(l.pending)}</div>

                    <div class="small text-muted mt-2">Monto pagado</div>
                    <div class="amount text-success my-1">${PEN.format(l.paid)}</div>

                    <button class="btn btn-primary btn-sm w-100 mt-3"
                            ${hasPending ? '' : 'disabled'}
                            onclick="${hasPending ? `markLentAsPaid('${l.lentTo}')` : ''}">
                      ${hasPending ? 'Liquidar' : 'Pagado'}
                    </button>
                  </div>`;
        });
        c.innerHTML = cards.join('');
    }

    async function loadBorrowed(period) {
        const { startDate, endDate } = getPeriodRange(period);
        const list = await fetch(`/api/resume/borrowed?startDate=${startDate}&endDate=${endDate}`).then(r => r.json());
        const c = document.getElementById('borrowedSection');
        if (!list.length) {
            c.innerHTML = `<div class="text-muted">No hay deudas pendientes</div>`;
            return;
        }

        // Group by borrowedFrom and calculate totals for PENDING / PAID
        const grouped = {};
        for (const item of list) {
            const name = item.borrowedFrom;
            if (!grouped[name]) {
                grouped[name] = { borrowedFrom: name, pending: 0, paid: 0 };
            }
            if (item.borrowedState === 'PENDING') grouped[name].pending += item.montoAcumulado ?? 0;
            else if (item.borrowedState === 'PAID') grouped[name].paid += item.montoAcumulado ?? 0;
        }

        console.log(grouped);

        const cards = Object.values(grouped).map(b => {
            const hasPending = b.pending > 0;
            const paidIcon = !hasPending
                ? `<i class="bi bi-check-circle-fill text-success" title="Deuda liquidada"></i>`
                : '';

            return `
                  <div class="loan-card shadow-hover h-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-arrow-down-circle text-info"></i>
                        <span class="fw-semibold">${b.borrowedFrom}</span>
                      </div>
                      ${paidIcon}
                    </div>

                    <div class="small text-muted">Monto pendiente</div>
                    <div class="amount my-1">${PEN.format(b.pending)}</div>

                    <div class="small text-muted mt-2">Monto pagado</div>
                    <div class="amount text-success my-1">${PEN.format(b.paid)}</div>

                    <button class="btn btn-primary btn-sm w-100 mt-3"
                            ${hasPending ? '' : 'disabled'}
                            onclick="${hasPending ? `markBorrowedAsPaid('${b.borrowedFrom}')` : ''}">
                      ${hasPending ? 'Liquidar' : 'Pagado'}
                    </button>
                  </div>`;
        });

        c.innerHTML = cards.join('');
    }

    async function markLentAsPaid(lentTo) {
        // Compute startDate and endDate using helper
        const period = document.getElementById('periodSelect').value;
        const { startDate, endDate } = getPeriodRange(period);
        console.log(startDate, endDate, lentTo);
        await fetch(`/api/resume/lent/${lentTo}/pay?startDate=${startDate}&endDate=${endDate}`, { method:'PUT' });
        await loadLent(period);
    }
    async function markBorrowedAsPaid(borrowedFrom) {
        // Compute startDate and endDate using helper
        const period = document.getElementById('periodSelect').value;
        const { startDate, endDate } = getPeriodRange(period);
        console.log(startDate, endDate, borrowedFrom);
        await fetch(`/api/resume/borrowed/${borrowedFrom}/pay?startDate=${startDate}&endDate=${endDate}`, { method:'PUT' });
        await loadBorrowed(period);
    }

</script>
</body>
</html>
